# Firewall Design V1

## Goals
For v1 of this firewall I want to build a fully working firewall with the follow key requirements:
- Captures, Evaluates and Decides on packets in the machine;
- Host-based, Linux and User-space
- Easily upgradable to kernel-space
- Great documentation explaining the learning process
- Good performance / metrics
- Document ways of breaking or bypassing the firewall

Things I want to avoid doing this project:
- Share mutable states across threads without caution
- Using non-explicit rules

## Design
To achieve this goal here is the structure for the v1, trying to make it easily scaled to kernel-space and gateway firewall.

### High-level modules design

note: fw-ctl must compile without libc, sockets or linux headers.

                          +--------------------------------------------------+
                          |                    fw-ctl                        |
                          |--------------------------------------------------|
                          | CLI / Config Loader                              |
                          | Rule Validation                                  |
                          | Rule Compilation (via fw-core)                   |
                          | IPC Client                                       |
                          +-------------------------+------------------------+
                                                    |
                                                    | compiled ruleset
                                                    v
                          +--------------------------------------------------+
                          |                    fw-user                       |
                          |--------------------------------------------------|
                          | Linux Integration                                |
                          |  - NFQUEUE / AF_PACKET                           |
                          |  - Netlink / Socket setup                        |
                          |  - Privilege handling                            |
                          |                                                  |
                          | Enforcement Backend                              |
                          | Verdict → ACCEPT / DROP / REJECT                 |
                          |                                                  |
                          | IPC Server                                       |
                          +-------------------------+------------------------+
                                                    |
                                                    | packets + metadata
                                                    v
                          +--------------------------------------------------+
                          |                    fw-core                       |
                          |--------------------------------------------------|
                          | Packet Parsing & Normalization                   |
                          | Flow Tracking                                    |
                          | Rule Engine                                      |
                          | Decision Pipeline                                |
                          | Telemetry Events (pure data)                     |
                          +--------------------------------------------------+

### fw-core structure
For the **fw-core** which is the main module in this project it will be as:
                                                              
                                       raw bytes
                                           |
                                           v
                    +--------------------------------------------------+
                    | packet                                           |
                    |--------------------------------------------------|
                    | ethernet → ip → transport                        |
                    |                                                  |
                    | Produces: ParsedPacket                           |
                    +-------------------------+------------------------+
                                              |
                                              v
                    +--------------------------------------------------+
                    | engine::pipeline                                 |
                    |--------------------------------------------------|
                    | 1. packet validity                               |
                    | 2. normalization                                 |
                    | 3. flow lookup                                   |
                    | 4. rule evaluation                               |
                    | 5. verdict                                       |
                    +-------------------------+------------------------+
                              |                       |
                              |                       |
                              v                       v
                    +------------------+    +--------------------------+
                    | flow             |    | rules                    |
                    |------------------|    |--------------------------|
                    | FlowKey          |    | AST                      |
                    | State machine    |    | Compiler                 |
                    | Timeouts         |    | Matchers                 |
                    | Table            |    | Actions                  |
                    +------------------+    +--------------------------+
                              |                       |
                              +-----------+-----------+
                                          |
                                          v
                    +--------------------------------------------------+
                    | engine::verdict                                  |
                    |--------------------------------------------------|
                    | Accept / Drop / Reject                           |
                    | DropReason                                       |
                    +-------------------------+------------------------+
                                              |
                                              v
                    +--------------------------------------------------+
                    | telemetry                                        |
                    |--------------------------------------------------|
                    | Events                                           |
                    | Counters                                         |
                    | Reason codes                                     |
                    +--------------------------------------------------+

### Rules

For the rules, the lifecycle should be:
                                                                                  
                          fw-ctl
                            |
                            | parse config (parsed once)
                            v
                          rules::ast
                            |
                            | compile() (compiled once)
                            v
                          rules::matcher   (immutable, optimized)
                            |
                            | send via IPC
                            v
                          fw-user
                            |
                            | install atomically
                            v
                          engine::pipeline

### Packets lifecycle

                                    Linux Kernel
                                         |
                                         | packet matches iptables rule
                                         v
                                    +-----------+
                                    | NFQUEUE   |
                                    +-----------+
                                         |
                                         | raw packet
                                         v
                            +------------------------+
                            | fw-user                |
                            |------------------------|
                            | receive packet         |
                            | call fw-core           |
                            +-----------+------------+
                                        |
                                        v
                            +------------------------+
                            | fw-core                |
                            |------------------------|
                            | parse → decide         |
                            +-----------+------------+
                                        |
                                        v
                            +------------------------+
                            | fw-user                |
                            |------------------------|
                            | verdict → kernel       |
                            +-----------+------------+
                                        |
                                        v
                                    ACCEPT / DROP
                            
Directions:

                                  +----------------+
                  Incoming packet |                | Outgoing packet
                  ----------------> fw-user        | <----------------
                                  |                |
                                  +----------------+
                                          |
                                          v
                                    fw-core
                                          |
                                          v
                                 Direction::Ingress
                                 Direction::Egress
                                           
                            
